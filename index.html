<!--
 * Copyright (c) 2024 OneNok_HK
 * Licensed under the MIT License. See LICENSE file in the project root for full license information.
-->
<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <title>particles life</title>
    <style>
        body {
            overflow: hidden;
            margin: 0;
            padding: 0;
            background-color: black;
        }

        #controls {
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
            position: fixed;
            top: 0;
            right: -300px;
            width: 300px;
            height: 100vh;
            background: rgba(255, 255, 255, 0.9);
            padding: 10px;
            box-sizing: border-box;
            overflow-y: auto;
            transition: right 0.3s ease-in-out;
            z-index: 1000;
        }

        #controls > div:not(#controls > div > div) {
            margin-top: 20px;
        }

        #controls.visible {
            right: 0;
        }

        #toggle-controls {
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
            position: fixed;
            top: 10px;
            right: 10px;
            z-index: 1001;
            background: rgba(255, 255, 255, 0.3);
            border: none;
            padding: 5px 10px;
            cursor: pointer;
            font-size: 12px;
            color: rgba(0, 0, 0, 0.7);
            transition: right 0.3s ease-in-out, opacity 0.3s ease;
            opacity: 0;
        }

        #toggle-controls:hover {
            opacity: 1;
        }

        /*canvas {
            border: 1px solid;
            border-color: rgb(63, 63, 63);
        }*/

        /* ä¿®æ”¹æ–‡å­—æ¨£å¼ï¼Œä½¿ç”¨ -webkit-text-stroke å‰µå»ºè¼ªå»“ */

        .one {
            -webkit-text-stroke: .375px black;
            -webkit-text-fill-color: #FF0000;
        }

        .two {
            -webkit-text-stroke: .375px black;
            -webkit-text-fill-color: #00FF00;
        }

        .three {
            -webkit-text-stroke: .375px black;
            -webkit-text-fill-color: #0000FF;
        }

        /* æŒ‰éˆ•çµ„æ¨£å¼ */
        .button-group {
            margin: 20px 0;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
        }

        .control-section {
            margin-bottom: 20px;
        }

        h3 {
            color: #272727;
            margin-bottom: 10px;
            font-size: 1.2em;
            text-shadow: 0 0 10px rgba(255, 255, 255, 0.5);
        }

        .button-container {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .styled-button {
            background: linear-gradient(145deg, #2a2a2a, #3a3a3a);
            border: none;
            padding: 10px 20px;
            color: #ffffff;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 14px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.5);
        }

        .styled-button:hover {
            background: linear-gradient(145deg, #3a3a3a, #2a2a2a);
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
        }

        .styled-button:active {
            transform: translateY(0);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        /* æ€§èƒ½æ•¸æ“šé¡¯ç¤ºå€åŸŸæ¨£å¼ */
        #performance-data {
            background: rgba(0, 0, 0, 0.3);
            padding: 15px;
            border-radius: 10px;
            margin: 20px 0;
            box-shadow: 0 0 15px rgba(0, 0, 0, 0.1);
        }

        #performance-data h3 {
            color: #fff;
            margin-bottom: 15px;
            text-shadow: 0 0 10px rgba(255, 255, 255, 0.5);
        }

        #performance-data p {
            color: #ffffff;
            margin: 10px 0;
            padding: 8px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 5px;
        }

        #performance-data span {
            color: #5dff62;
            font-weight: bold;
        }

        /* æ§åˆ¶å…ƒç´ æ¨£å¼ */
        input[type="range"] {
            width: 200px;
            height: 5px;
            border-radius: 5px;
            background: #4d4d4d;
            outline: none;
            opacity: 0.7;
            transition: opacity 0.2s;
        }

        input[type="range"]:hover {
            opacity: 1;
            background: #6e6e6e;
        }

        input[type="number"] {
            width: 70px;
            padding: 2px 5px;
            border: 1px solid #4d4d4d;
            border-radius: 4px;
            background: rgba(0, 0, 0, 0.3);
            color: #ffffff;
            font-size: 13px;
            height: 20px;
            box-sizing: border-box;
            margin-top: 5px;
        }

        input[type="number"]:focus,
        select:focus {
            border-color: #6e6e6e;
            outline: none;
            box-shadow: 0 0 5px rgba(110, 110, 110, 0.5);
        }

        select {
            padding: 2px 5px;
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid #4d4d4d;
            border-radius: 4px;
            color: #ffffff;
            font-size: 13px;
            height: 20px;
        }

        /* æ¨™ç±¤æ¨£å¼ */
        label {
            color: #d0d0d0;
            margin-right: 10px;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.5);
        }

        /* è¤‡é¸æ¡†æ¨£å¼ */
        input[type="checkbox"] {
            width: 16px;
            height: 16px;
            margin-right: 10px;
        }

        /* ä¸€èˆ¬æ¨™ç±¤å’Œæ–‡å­—çš„é»˜èªé¡è‰² */
        label {
            color: #2e2e2e;
            margin-right: 10px;
        }

        /* ä¸€èˆ¬æ®µè½æ–‡å­— */
        p {
            color: #2e2e2e;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.5);
        }

        /* æœ‰ç‰¹å®šèƒŒæ™¯çš„å…ƒç´ ä¿æŒç™½è‰²æ–‡å­— */
        #performance-data p {
            color: #ffffff;
        }

        /* ä¿æŒæŒ‰éˆ•æ–‡å­—ç‚ºç™½è‰²ï¼Œå› ç‚ºæŒ‰éˆ•æœ‰æ·±è‰²èƒŒæ™¯ */
        .styled-button {
            color: #d0d0d0;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.5);
        }

        /* æ€§èƒ½æ•¸æ“šå€åŸŸä¿æŒç™½è‰²æ–‡å­— */
        #performance-data h3,
        #performance-data p {
            color: #ffffff;
        }

        /* æ€§èƒ½æ•¸æ“šä¸­çš„æ•¸å€¼ä¿æŒç¶ è‰² */
        #performance-data span {
            color: #5dff62;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.5);
        }

        /* åˆ‡æ›é–‹é—œå®¹å™¨ */
        .toggle-container {
            margin: 10px 0;
            display: flex;
        }

        /* æ¨™ç±¤æ¨£å¼ */
        .toggle-label {
            width: fit-content;
            display: flex;
            align-items: center;
            gap: 10px;
            cursor: default;
            pointer-events: none;
        }

        /* åˆ‡æ›é–‹é—œå¤–è§€ */
        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 24px;
        }

        /* éš±è—åŸå§‹è¤‡é¸æ¡†ï¼Œä½†ä¿æŒåœ¨æ»‘å¡Šä½ç½® */
        .toggle-switch input {
            position: absolute;
            opacity: 0;
            width: 100%;
            height: 100%;
            cursor: pointer;
            z-index: 1; /* ç¢ºä¿è¤‡é¸æ¡†åœ¨æœ€ä¸Šå±¤ */
            margin: 0; /* ç§»é™¤é»˜èªé‚Šè· */
        }

        /* æ»‘å¡Šæ¨£å¼ */
        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #4d4d4d;
            transition: .3s;
            border-radius: 24px;
            pointer-events: none; /* ç¢ºä¿æ»‘å¡Šä¸æœƒå¹²æ“¾é»æ“Šäº‹ä»¶ */
        }

        /* æ»‘å¡Šçš„åœ“å½¢æŒ‰éˆ• */
        .slider:before {
            position: absolute;
            content: "";
            height: 16px;
            width: 16px;
            left: 4px;
            bottom: 4px;
            background-color: #d0d0d0;
            transition: .3s;
            border-radius: 50%;
        }

        /* é¸ä¸­ç‹€æ…‹çš„æ¨£å¼ */
        input:checked + .slider {
            background-color: #4CAF50;
        }

        /* æ»‘å¡Šæ‡¸åœæ•ˆæœ */
        .slider:hover {
            box-shadow: 0 0 5px rgba(76, 175, 80, 0.5);
        }

        /* é¸ä¸­ç‹€æ…‹ä¸‹åœ“å½¢æŒ‰éˆ•çš„ä½ç½® */
        input:checked + .slider:before {
            transform: translateX(26px);
            background-color: #ffffff;
        }
    </style>
</head>

<body>
    <button id="toggle-controls">â˜°</button>
    <div id="controls">
        <!-- åœ¨ HTML ä¸­ï¼Œç‚ºéœ€è¦éš¨æ©ŸåŒ–çš„æ»‘å¡Šæ·»åŠ  'randomizable' é¡ -->
        <!-- ä¸€è™Ÿ -->
        <div>
            <div>
                <label for="one-one"><span class="one">ä¸€è™Ÿ->ä¸€è™Ÿ:</span></label>
                <input type="range" id="one-one" class="randomizable rules" min="-1" max="1" step="0.1" value="0.4">
                <input type="number" id="one-one-number" min="-1" max="1" step="0.1" value="0.4">
            </div>
            <div>
                <label for="one-one-distance"><span class="one">ä¸€è™Ÿ->ä¸€è™Ÿè·é›¢:</span></label>
                <input type="range" id="one-one-distance" class="randomizable rules" min="10" max="300" step="10" value="150">
                <input type="number" id="one-one-distance-number" min="10" max="300" step="10" value="150">
            </div>
            <div>
                <label for="one-two"><span class="one">ä¸€è™Ÿ-></span><span class="two">äºŒè™Ÿ:</span></label>
                <input type="range" id="one-two" class="randomizable rules" min="-1" max="1" step="0.1" value="-0.6">
                <input type="number" id="one-two-number" min="-1" max="1" step="0.1" value="-0.6">
            </div>
            <div>
                <label for="one-two-distance"><span class="one">ä¸€è™Ÿ-></span><span class="two">äºŒè™Ÿè·é›¢:</span></label>
                <input type="range" id="one-two-distance" class="randomizable rules" min="10" max="300" step="10" value="12">
                <input type="number" id="one-two-distance-number" min="10" max="300" step="10" value="12">
            </div>
            <div>
                <label for="one-three"><span class="one">ä¸€è™Ÿ-></span><span class="three">ä¸‰è™Ÿ:</span></label>
                <input type="range" id="one-three" class="randomizable rules" min="-1" max="1" step="0.1" value="0.5">
                <input type="number" id="one-three-number" min="-1" max="1" step="0.1" value="0.5">
            </div>
            <div>
                <label for="one-three-distance"><span class="one">ä¸€è™Ÿ-></span><span class="three">ä¸‰è™Ÿè·é›¢:</span></label>
                <input type="range" id="one-three-distance" class="randomizable rules" min="10" max="300" step="10" value="10">
                <input type="number" id="one-three-distance-number" min="10" max="300" step="10" value="10">
            </div>
        </div>
        <!-- äºŒè™Ÿ -->
        <div>
            <div>
                <label for="two-two"><span class="two">äºŒè™Ÿ->äºŒè™Ÿ:</span></label>
                <input type="range" id="two-two" class="randomizable rules" min="-1" max="1" step="0.1" value="0.5">
                <input type="number" id="two-two-number" min="-1" max="1" step="0.1" value="0.5">
            </div>
            <div>
                <label for="two-two-distance"><span class="two">äºŒè™Ÿ->äºŒè™Ÿè·é›¢:</span></label>
                <input type="range" id="two-two-distance" class="randomizable rules" min="10" max="300" step="10" value="100">
                <input type="number" id="two-two-distance-number" min="10" max="300" step="10" value="100">
            </div>
            <div>
                <label for="two-three"><span class="two">äºŒè™Ÿ-></span><span class="three">ä¸‰è™Ÿ:</span></label>
                <input type="range" id="two-three" class="randomizable rules" min="-1" max="1" step="0.1" value="0.5">
                <input type="number" id="two-three-number" min="-1" max="1" step="0.1" value="0.5">
            </div>
            <div>
                <label for="two-three-distance"><span class="two">äºŒè™Ÿ-></span><span class="three">ä¸‰è™Ÿè·é›¢:</span></label>
                <input type="range" id="two-three-distance" class="randomizable rules" min="10" max="300" step="10"
                    value="100">
                <input type="number" id="two-three-distance-number" min="10" max="300" step="10" value="100">
            </div>
            <div>
                <label for="two-one"><span class="two">äºŒè™Ÿ-></span><span class="one">ä¸€è™Ÿ:</span></label>
                <input type="range" id="two-one" class="randomizable rules" min="-1" max="1" step="0.1" value="0.5">
                <input type="number" id="two-one-number" min="-1" max="1" step="0.1" value="0.5">
            </div>
            <div>
                <label for="two-one-distance"><span class="two">äºŒè™Ÿ-></span><span class="one">ä¸€è™Ÿè·é›¢:</span></label>
                <input type="range" id="two-one-distance" class="randomizable rules" min="10" max="300" step="10" value="200">
                <input type="number" id="two-one-distance-number" min="10" max="300" step="10" value="200">
            </div>
        </div>
        <!-- ä¸‰è™Ÿ -->
        <div>
            <div>
                <label for="three-three"><span class="three">ä¸‰è™Ÿ->ä¸‰è™Ÿ:</span></label>
                <input type="range" id="three-three" class="randomizable rules" min="-1" max="1" step="0.1" value="0.4">
                <input type="number" id="three-three-number" min="-1" max="1" step="0.1" value="0.4">
            </div>
            <div>
                <label for="three-three-distance"><span class="three">ä¸‰è™Ÿ->ä¸‰è™Ÿè·é›¢:</span></label>
                <input type="range" id="three-three-distance" class="randomizable rules" min="10" max="300" step="10"
                    value="130">
                <input type="number" id="three-three-distance-number" min="10" max="300" step="10" value="130">
            </div>
            <div>
                <label for="three-one"><span class="three">ä¸‰è™Ÿ-></span><span class="one">ä¸€è™Ÿ:</span></label>
                <input type="range" id="three-one" class="randomizable rules" min="-1" max="1" step="0.1" value="-0.5">
                <input type="number" id="three-one-number" min="-1" max="1" step="0.1" value="-0.5">
            </div>
            <div>
                <label for="three-one-distance"><span class="three">ä¸‰è™Ÿ-></span><span class="one">ä¸€è™Ÿè·é›¢:</span></label>
                <input type="range" id="three-one-distance" class="randomizable rules" min="10" max="300" step="10"
                    value="100">
                <input type="number" id="three-one-distance-number" min="10" max="300" step="10" value="100">
            </div>
            <div>
                <label for="three-two"><span class="three">ä¸‰è™Ÿ-></span><span class="two">äºŒè™Ÿ:</span></label>
                <input type="range" id="three-two" class="randomizable rules" min="-1" max="1" step="0.1" value="-0.5">
                <input type="number" id="three-two-number" min="-1" max="1" step="0.1" value="-0.5">
            </div>
            <div>
                <label for="three-two-distance"><span class="three">ä¸‰è™Ÿ-></span><span class="two">äºŒè™Ÿè·é›¢:</span></label>
                <input type="range" id="three-two-distance" class="randomizable rules" min="10" max="300" step="10"
                    value="10">
                <input type="number" id="three-two-distance-number" min="10" max="300" step="10" value="10">
            </div>
        </div>

        <!-- å°‡æŒ‰éˆ•çµ„é‡çµ„ç¹”ä¸¦æ·»åŠ æ¨£å¼ -->
        <div class="button-group">
            <!-- åŸºæœ¬æ“ä½œæŒ‰éˆ• -->
            <div class="control-section">
                <h3>ğŸ® åŸºæœ¬æ“ä½œ</h3>
                <div class="button-container">
                    <button id="randomize-button" class="styled-button">ğŸ² éš¨æ©ŸåŒ–æ‰€æœ‰å€¼</button>
                    <button id="restart-button" class="styled-button">ğŸ”„ é‡æ–°é–‹å§‹éŠæˆ²</button>
                    <button id="randomize-and-restart-button" class="styled-button">ğŸ¯ éš¨æ©ŸåŒ–ä¸¦é‡æ–°é–‹å§‹</button>
                </div>
            </div>

            <!-- è¦å‰‡å°å…¥å°å‡ºæŒ‰éˆ• -->
            <div class="control-section">
                <h3>ğŸ’¾ è¦å‰‡ç®¡ç†</h3>
                <div class="button-container">
                    <button id="export-rules" class="styled-button">ğŸ“¤ åŒ¯å‡ºè¦å‰‡</button>
                    <button id="import-rules" class="styled-button">ğŸ“¥ å°å…¥è¦å‰‡</button>
                    <button id="import-rules-and-restart" class="styled-button">ğŸ“‹ å°å…¥è¦å‰‡ä¸¦é‡æ–°é–‹å§‹</button>
                </div>
            </div>
            <input type="file" id="import-file" style="display: none;">
        </div>

        <div>
            <div class="one">
                <label for="one-particles">ä¸€è™Ÿç²’å­æ•¸é‡:</label>
                <input type="range" id="one-particles" class="rules" min="10" max="500" step="10" value="250">
                <input type="number" id="one-particles-number" min="10" max="500" step="10" value="250">
            </div>
            <div class="two">
                <label for="two-particles">äºŒè™Ÿç²’å­æ•¸é‡:</label>
                <input type="range" id="two-particles" class="rules" min="10" max="500" step="10" value="250">
                <input type="number" id="two-particles-number" min="10" max="500" step="10" value="250">
            </div>
            <div class="three">
                <label for="three-particles">ä¸‰è™Ÿç²’å­æ•¸é‡:</label>
                <input type="range" id="three-particles" class="rules" min="10" max="500" step="10" value="250">
                <input type="number" id="three-particles-number" min="10" max="500" step="10" value="250">
            </div>
        </div>

        <div class="toggle-container">
            <label for="isThrough" class="toggle-label">æ˜¯å¦ç©¿é€</label>
            <div class="toggle-switch">
                <input type="checkbox" id="isThrough">
                <span class="slider"></span>
            </div>
        </div>

        <!-- æ·»åŠ æ»‘é¼ å¸å¼•åŠ›æ»‘å¡Š -->
        <div>
            <label for="mouse-force">æ»‘é¼ å¸å¼•åŠ›:</label>
            <input type="range" id="mouse-force" min="0" max="10" step="0.1" value="5">
            <input type="number" id="mouse-force-number" min="0" max="10" step="0.1" value="5">
        </div>

        <!-- æ·»åŠ é¡è‰²é¸æ“‡å™¨ -->
        <div>
            <div class="one">
                <label for="one-color">ä¸€è™Ÿç²’å­é¡è‰²:</label>
                <input type="color" id="one-color" value="#FF0000">
            </div>
            <div class="two">
                <label for="two-color">äºŒè™Ÿç²’å­é¡è‰²:</label>
                <input type="color" id="two-color" value="#00FF00">
            </div>
            <div class="three">
                <label for="three-color">ä¸‰è™Ÿç²’å­é¡è‰²:</label>
                <input type="color" id="three-color" value="#0000FF">
            </div>
        </div>

        <div>
            <label for="updateInterval">æ›´æ–°é–“éš”(ms):</label>
            <input type="range" id="updateInterval" min="1" max="2000" step="0.01" value="16.66">
            <input type="number" id="updateInterval-number" min="1" max="2000" step="0.01" value="16.66">
            <select id="updateInterval-unit">
                <option value="33.33">30 UPS</option>
                <option value="16.66" selected>60 UPS</option>
                <option value="8.33">120 UPS</option>
                <option value="6.94">144 UPS</option>
                <option value="6.06">165 UPS</option>
                <option value="4.16">240 UPS</option>
                <option value="2.77">360 UPS</option>
                <option value="2.08">480 UPS</option>
                <option value="2.00">500 UPS</option>
                <option value="1.85">540 UPS</option>
                <option value="1.66">600 UPS</option>
                <option value="1.38">720 UPS</option>
            </select>
            <p>UPS: Update Per Secondï¼Œæ¯ç§’æ›´æ–°æ¬¡æ•¸</p>
            <p>æ³¨æ„: æ›´æ–°é–“éš”è¶ŠçŸ­ï¼Œç²’å­é‹å‹•è¶Šæµæš¢ï¼Œä½†æœƒå¢åŠ CPUè² æ“”ã€‚</p>
        </div>

        <!-- åœ¨æ§åˆ¶é¢æ¿ä¸­æ·»åŠ æ€§èƒ½æ•¸æ“šé¡¯ç¤º -->
        <div id="performance-data">
            <h3>æ€§èƒ½æ•¸æ“š</h3>
            <p>æ¸²æŸ“FPS: <span id="fps"></span><br>(é€™ä¸¦ä¸æ˜¯éŠæˆ²æ¯ç§’æ›´æ–°æ¬¡æ•¸ã€‚)</p>
            <p>ç²’å­æ›´æ–°ç¸½æ™‚é–“: 
                <br>ç•¶å‰: <span id="total-time"></span> ms 
                <br>å¹³å‡: <span id="total-time-average"></span> ms
                <br>æœ€å¤§: <span id="total-time-max"></span> ms
            </p>
            <p>ç¶²æ ¼é‡ç½®æ™‚é–“: 
                <br>ç•¶å‰: <span id="grid-reset-time"></span> ms 
                <br>å¹³å‡: <span id="grid-reset-time-average"></span> ms
                <br>æœ€å¤§: <span id="grid-reset-time-max"></span> ms
            </p>
            <p>å–å¾—é™„è¿‘ç²’å­æ™‚é–“: 
                <br>ç•¶å‰: <span id="get-nearby-time"></span> ms 
                <br>å¹³å‡: <span id="get-nearby-time-average"></span> ms
                <br>æœ€å¤§: <span id="get-nearby-time-max"></span> ms
            </p>
            <p>é‡åŠ›å½±éŸ¿è¨ˆç®—æ™‚é–“: 
                <br>ç•¶å‰: <span id="g-Affect-Calc-time"></span> ms 
                <br>å¹³å‡: <span id="g-Affect-Calc-time-average"></span> ms
                <br>æœ€å¤§: <span id="g-Affect-Calc-time-max"></span> ms
            </p>
            <p>æ›´æ–°ä½ç½®æ™‚é–“: 
                <br>ç•¶å‰: <span id="position-update-time"></span> ms 
                <br>å¹³å‡: <span id="position-update-time-average"></span> ms
                <br>æœ€å¤§: <span id="position-update-time-max"></span> ms
            </p>
        </div>

        <!-- åœ¨æ§åˆ¶é¢æ¿ä¸­æ·»åŠ æ–°çš„æ§åˆ¶å…ƒç´  -->
        <div class="grid-controls">
            <h3>ğŸ”² ç¶²æ ¼è¨­ç½®</h3>
            <div class="toggle-container">
                <label for="showGrid" class="toggle-label">é¡¯ç¤ºç¶²æ ¼</label>
                <div class="toggle-switch">
                    <input type="checkbox" id="showGrid">
                    <span class="slider"></span>
                </div>
            </div>
            <div>
                <p>ç•¶å‰æ‰€é¸å–®å…ƒæ ¼: <span id="selected-cell"></span></p>
                <p>ç¶²æ ¼å¯¬åº¦: <span id="grid-width"></span></p>
                <p>ç¶²æ ¼é«˜åº¦: <span id="grid-height"></span></p>
            </div>
            <div>
                <label for="setectGridDistance">æ¨¡æ“¬ä½œç”¨ç¯„åœ: </label>
                <input type="range" id="setectGridDistance" min="10" max="500" step="10" value="250">
                <input type="number" id="setectGridDistance-number" min="10" max="500" step="10" value="250">
            </div>
            <div>
                <label for="cell-size">ç¶²æ ¼å¤§å°:</label>
                <input type="range" id="cell-size" min="10" max="100" step="1" value="50">
                <input type="number" id="cell-size-number" min="10" max="100" step="1" value="50">
            </div>
        </div>

        <!-- åœ¨æ€§èƒ½æ•¸æ“šé¡¯ç¤ºå€åŸŸä¹‹å¾Œæ·»åŠ ä»¥ä¸‹ä»£ç¢¼ -->
        <div>
            <h3>ç²’å­å½±éŸ¿ç¯„åœé¡¯ç¤º</h3>
            <div>
                <label for="enableParticleAffcetRadiusShow">å•Ÿç”¨ç²’å­å½±éŸ¿ç¯„åœé¡¯ç¤º: </label>
                <input type="checkbox" id="enableParticleAffcetRadiusShow">
            </div>
            <div>
                <label for="isOneRadiusShow">é¡¯ç¤ºä¸€è™Ÿç²’å­å½±éŸ¿ç¯„åœ</label>
                <input type="checkbox" id="isOneRadiusShow" checked>
            </div>
            <div>
                <label for="isTwoRadiusShow">é¡¯ç¤ºäºŒè™Ÿç²’å­å½±éŸ¿ç¯„åœ</label>
                <input type="checkbox" id="isTwoRadiusShow" checked>
            </div>
            <div>
                <label for="isThreeRadiusShow">é¡¯ç¤ºä¸‰è™Ÿç²’å­å½±éŸ¿ç¯„åœ</label>
                <input type="checkbox" id="isThreeRadiusShow" checked>
            </div>
            <div>
                <p>é¸ä¸­çš„ç²’å­ID: <span id="selectedParticleId">ç„¡</span></p>
                <p>é¸ä¸­çš„ç²’å­å±¬æ€§: <span id="selectedParticleProperty"></span></p>
                <p>ç¯„åœå…§çš„ä¸€è™Ÿç²’å­æ•¸é‡: <span id="nearbyParticlesOneNumber"></span></p>
                <p>ç¯„åœå…§çš„äºŒè™Ÿç²’å­æ•¸é‡: <span id="nearbyParticlesTwoNumber"></span></p>
                <p>ç¯„åœå…§çš„ä¸‰è™Ÿç²’å­æ•¸é‡: <span id="nearbyParticlesThreeNumber"></span></p>
            </div>
        </div>
        <div>
            <p style="font-size: 1.2em; font-weight: bold; color: #ff6b6b; text-shadow: 1px 1px 2px rgba(0,0,0,0.2); margin: 15px 0;">ğŸ’¬ äº¤æµèˆ‡åé¥‹</p>
            <a href="https://github.com/onenok/ParticlesLife.html/issues" style="text-decoration: none; display: flex; align-items: center; gap: 8px; padding: 8px 16px; border-radius: 6px; background: #24292e; color: white; width: fit-content; transition: background 0.2s;">
                <svg height="24" aria-hidden="true" viewBox="0 0 24 24" version="1.1" width="24" fill="currentColor">
                    <path d="M12.5.75C6.146.75 1 5.896 1 12.25c0 5.089 3.292 9.387 7.863 10.91.575.101.79-.244.79-.546 0-.273-.014-1.178-.014-2.142-2.889.532-3.636-.704-3.866-1.35-.13-.331-.69-1.352-1.18-1.625-.402-.216-.977-.748-.014-.762.906-.014 1.553.834 1.769 1.179 1.035 1.74 2.688 1.25 3.349.948.1-.747.402-1.25.733-1.538-2.559-.287-5.232-1.279-5.232-5.678 0-1.25.445-2.285 1.178-3.09-.115-.288-.517-1.467.115-3.048 0 0 .963-.302 3.163 1.179.92-.259 1.897-.388 2.875-.388.977 0 1.955.13 2.875.388 2.2-1.495 3.162-1.179 3.162-1.179.633 1.581.23 2.76.115 3.048.733.805 1.179 1.825 1.179 3.09 0 4.413-2.688 5.39-5.247 5.678.417.36.776 1.05.776 2.128 0 1.538-.014 2.774-.014 3.162 0 .302.216.662.79.547C20.709 21.637 24 17.324 24 12.25 24 5.896 18.854.75 12.5.75Z"></path>
                </svg>
                <span style="font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Helvetica, Arial, sans-serif;">GitHub Issues</span>
            </a>
        </div>
    </div>
    <canvas id="board2d"></canvas>

    <script>
        // å‰µå»º Web Worker
        const worker = new Worker('particleWorker.js');

        document.addEventListener('DOMContentLoaded', () => {
            const canvas2d = document.getElementById("board2d");
            const ctx = canvas2d.getContext("2d");
            const ballRadius = 3;
            let nearbyParticlesOne = [];
            let nearbyParticlesTwo = [];
            let nearbyParticlesThree = [];
            let selectedParticleId = null;
            let enableParticleAffcetRadiusShow = false;
            let isOneRadiusShow = true;
            let isTwoRadiusShow = true;
            let isThreeRadiusShow = true;

            // ç§»é™¤ WebGL ç›¸é—œè®Šé‡
            /*
            let useWebGL = false; // ä¿ç•™é€™å€‹è®Šé‡ï¼Œä½†å§‹çµ‚ç‚º false
            */

            function updateCanvasSize() {
                const controlPanel = document.getElementById('controls');
                const isPanelVisible = controlPanel.classList.contains('visible');
                const width = document.documentElement.clientWidth - (isPanelVisible ? 300 : 0);
                const height = document.documentElement.clientHeight;

                canvas2d.width = width;
                canvas2d.height = height;

                // è¨­ç½® Canvas æ¨£å¼
                canvas2d.style.position = 'absolute';
                canvas2d.style.left = '0';
                canvas2d.style.top = '0';

                worker.postMessage({ type: 'updateCanvasSize', width, height });
            }

            let showGrid = false;

            function draw(particles, gridData) {
                ctx.clearRect(0, 0, canvas2d.width, canvas2d.height);
                ctx.fillStyle = 'black';
                ctx.fillRect(0, 0, canvas2d.width, canvas2d.height);
                
                if (showGrid && gridData) {
                    drawGrid(ctx, gridData);
                }

                const enableParticleAffcetRadiusShow = document.getElementById('enableParticleAffcetRadiusShow').checked;
                
                particles.forEach(p => {
                    ctx.beginPath();
                    ctx.arc(p.x, p.y, ballRadius, 0, Math.PI * 2);
                    
                    if (enableParticleAffcetRadiusShow) {
                        if (p.id === selectedParticleId) {
                            let isXOverflow = false;
                            let isYOverflow = false;
                            let newx = p.x;
                            let newy = p.y;
                            ctx.fillStyle = 'rgba(255, 255, 255, 1)';
                            ctx.fill();
                            ctx.closePath();
                            if (isOneRadiusShow) {
                                ctx.beginPath();
                                ctx.arc(p.x, p.y, radiusOne.value, 0, Math.PI * 2);
                                ctx.fillStyle = 'rgba(255, 0, 0, 0.1)';
                                ctx.fill();
                                ctx.closePath();
                                if (throughCheckbox.checked) {
                                    isXOverflow = false;
                                    isYOverflow = false;
                                    newx = p.x;
                                    newy = p.y;
                                    if ((p.x < radiusOne.value || p.x > canvas2d.width - radiusOne.value)){
                                        isXOverflow = true;
                                        newx = p.x < radiusOne.value ? p.x + canvas2d.width : p.x - canvas2d.width;
                                        ctx.beginPath();
                                        ctx.arc(newx, p.y, radiusOne.value, 0, Math.PI * 2);
                                        ctx.fillStyle = 'rgba(255, 0, 0, 0.1)';
                                        ctx.fill();
                                        ctx.closePath();
                                    }
                                    if ((p.y < radiusOne.value || p.y > canvas2d.height - radiusOne.value)){
                                        isYOverflow = true;
                                        newy = p.y < radiusOne.value ? p.y + canvas2d.height : p.y - canvas2d.height;
                                        ctx.beginPath();
                                        ctx.arc(p.x, newy, radiusOne.value, 0, Math.PI * 2);
                                        ctx.fillStyle = 'rgba(255, 0, 0, 0.1)';
                                        ctx.fill();
                                        ctx.closePath();
                                    }
                                    if (isXOverflow && isYOverflow) {
                                        ctx.beginPath();
                                        ctx.arc(newx, newy, radiusOne.value, 0, Math.PI * 2);
                                        ctx.fillStyle = 'rgba(255, 0, 0, 0.1)';
                                        ctx.fill();
                                        ctx.closePath();
                                    }
                                }
                            }
                            if (isTwoRadiusShow) {  
                                ctx.beginPath()
                                ctx.arc(p.x, p.y, radiusTwo.value, 0, Math.PI * 2);
                                ctx.fillStyle = 'rgba(0, 255, 0, 0.1)';
                                ctx.fill();
                                ctx.closePath();
                                if (throughCheckbox.checked) {
                                    isXOverflow = false;
                                    isYOverflow = false;
                                    newx = p.x;
                                    newy = p.y; 
                                    if ((p.x < radiusTwo.value || p.x > canvas2d.width - radiusTwo.value)){
                                        isXOverflow = true;
                                        newx = p.x < radiusTwo.value ? p.x + canvas2d.width : p.x - canvas2d.width;
                                        ctx.beginPath();
                                        ctx.arc(newx, p.y, radiusTwo.value, 0, Math.PI * 2);
                                        ctx.fillStyle = 'rgba(0, 255, 0, 0.1)';
                                        ctx.fill();
                                        ctx.closePath();
                                    }
                                    if ((p.y < radiusTwo.value || p.y > canvas2d.height - radiusTwo.value)){
                                        isYOverflow = true;
                                        newy = p.y < radiusTwo.value ? p.y + canvas2d.height : p.y - canvas2d.height;
                                        ctx.beginPath();
                                        ctx.arc(p.x, newy, radiusTwo.value, 0, Math.PI * 2);
                                        ctx.fillStyle = 'rgba(0, 255, 0, 0.1)';
                                        ctx.fill();
                                        ctx.closePath();
                                    }
                                    if (isXOverflow && isYOverflow) {
                                        ctx.beginPath();
                                        ctx.arc(newx, newy, radiusTwo.value, 0, Math.PI * 2);
                                        ctx.fillStyle = 'rgba(0, 255, 0, 0.1)';
                                        ctx.fill();
                                        ctx.closePath();
                                    }
                                }
                            }
                            if (isThreeRadiusShow) {
                                ctx.beginPath();
                                ctx.arc(p.x, p.y, radiusThree.value, 0, Math.PI * 2);
                                ctx.fillStyle = 'rgba(0, 0, 255, 0.1)';
                                ctx.fill();
                                ctx.closePath();
                                if (throughCheckbox.checked) {
                                    isXOverflow = false;
                                    isYOverflow = false;
                                    newx = p.x;
                                    newy = p.y;
                                    if ((p.x < radiusThree.value || p.x > canvas2d.width - radiusThree.value)){
                                        isXOverflow = true;
                                        newx = p.x < radiusThree.value ? p.x + canvas2d.width : p.x - canvas2d.width;
                                        ctx.beginPath();
                                        ctx.arc(newx, p.y, radiusThree.value, 0, Math.PI * 2);
                                        ctx.fillStyle = 'rgba(0, 0, 255, 0.1)';
                                        ctx.fill();
                                        ctx.closePath();
                                    }   
                                    if ((p.y < radiusThree.value || p.y > canvas2d.height - radiusThree.value)){
                                        isYOverflow = true;
                                        newy = p.y < radiusThree.value ? p.y + canvas2d.height : p.y - canvas2d.height;
                                        ctx.beginPath();
                                        ctx.arc(p.x, newy, radiusThree.value, 0, Math.PI * 2);
                                        ctx.fillStyle = 'rgba(0, 0, 255, 0.1)';
                                        ctx.fill();
                                        ctx.closePath();
                                    }
                                    if (isXOverflow && isYOverflow) {
                                        ctx.beginPath();
                                        ctx.arc(newx, newy, radiusThree.value, 0, Math.PI * 2);
                                        ctx.fillStyle = 'rgba(0, 0, 255, 0.1)';
                                        ctx.fill();
                                        ctx.closePath();
                                    }
                                }
                            }
                        } else if (nearbyParticlesOne.includes(p) && isOneRadiusShow) {
                            ctx.fillStyle = 'red';
                            ctx.fill();
                            ctx.closePath();
                        } else if (nearbyParticlesTwo.includes(p) && isTwoRadiusShow) {
                            ctx.fillStyle = 'green';
                            ctx.fill();
                            ctx.closePath();
                        } else if (nearbyParticlesThree.includes(p) && isThreeRadiusShow) {
                            ctx.fillStyle = 'blue';
                            ctx.fill();
                            ctx.closePath();
                        } else {
                            ctx.fillStyle = 'gray';
                            ctx.fill();
                            ctx.closePath();
                        }
                    } else {
                        ctx.fillStyle = p.isOutside ? 'white' : p.color;
                        ctx.fill();
                        ctx.closePath();
                    }
                });
            }

            function drawGrid(ctx, gridData) {
                const { cellSize, width, height, canvasWidth, canvasHeight, selectedCell, nearbyCells } = gridData;
                
                ctx.strokeStyle = 'rgba(255, 255, 255, 0.1)';
                ctx.lineWidth = 1;

                // ç¹ªè£½å‚ç›´ç·š
                for (let x = 0; x <= width; x++) {
                    ctx.beginPath();
                    ctx.moveTo(x * cellSize, 0);
                    ctx.lineTo(x * cellSize, Math.min(height * cellSize, canvasHeight));
                    ctx.stroke();
                }

                // ç¹ªè£½æ°´å¹³ç·š
                for (let y = 0; y <= height; y++) {
                    ctx.beginPath();
                    ctx.moveTo(0, y * cellSize);
                    ctx.lineTo(Math.min(width * cellSize, canvasWidth), y * cellSize);
                    ctx.stroke();
                }

                // ç¹ªè£½é¸ä¸­çš„å–®å…ƒæ ¼å’Œé™„è¿‘çš„å–®å…ƒæ ¼
                if (selectedCell) {
                    ctx.fillStyle = 'rgba(255, 255, 0, 0.2)';
                    ctx.fillRect(selectedCell.x * cellSize, selectedCell.y * cellSize, cellSize, cellSize);

                    ctx.fillStyle = 'rgba(0, 255, 0, 0.1)';
                    nearbyCells.forEach(cell => {
                        ctx.fillRect(cell.x * cellSize, cell.y * cellSize, cellSize, cellSize);
                    });
                }
            }

            // ç§»é™¤ WebGL ç›¸é—œçš„äº‹ä»¶ç›£è½å™¨å’Œå‡½æ•¸èª¿ç”¨
            /*
            // ä¾‹å¦‚ï¼Œç§»é™¤ useWebGLCheckbox ç›¸é—œçš„ä»£ç¢¼
            const useWebGLCheckbox = document.getElementById("useWebGL");
            useWebGLCheckbox.addEventListener('change', () => { ... });
            */

            // åˆå§‹åŒ–éŠæˆ²å‡½æ•¸ä¿®æ”¹
            function initGame() {
                performanceData.totalTimeAll = [];
                performanceData.gridResetTimeAll = [];
                performanceData.getNearbyTimeAll = [];
                performanceData.gAffectCalcTimeAll = [];
                performanceData.positionUpdateTimeAll = [];
                performanceData.totalTimeMax = 0;
                performanceData.gridResetTimeMax = 0;
                performanceData.getNearbyTimeMax = 0;
                performanceData.gAffectCalcTimeMax = 0;
                performanceData.positionUpdateTimeMax = 0;
                const oneCount = parseInt(document.getElementById('one-particles').value);
                const twoCount = parseInt(document.getElementById('two-particles').value);
                const threeCount = parseInt(document.getElementById('three-particles').value);
                worker.postMessage({
                    type: 'init',
                    oneCount,
                    twoCount,
                    threeCount,
                    canvasWidth: canvas2d.width,
                    canvasHeight: canvas2d.height,
                    colors: {
                        one: document.getElementById('one-color').value,
                        two: document.getElementById('two-color').value,
                        three: document.getElementById('three-color').value
                    }
                });
            }

            // åˆå§‹åŒ– canvas å°ºå¯¸
            updateCanvasSize();

            // ç›£è½è¦–çª—å¤§å°è®ŠåŒ–
            window.addEventListener("resize", updateCanvasSize);

            // æ·»åŠ  FPS è¨ˆç®—ç›¸é—œè®Šé‡
            let frameCount = 0;
            let lastTime = performance.now();
            let fps = 0;

            let gridCellSize = 50; // é»˜èªå€¼
            let particles = [];
            let performanceData = {
                totalTime: 0,
                totalTimeAll: [],
                totalTimeMax: 0,
                gridResetTime: 0,
                gridResetTimeAll: [],
                gridResetTimeMax: 0,
                getNearbyTime: 0,
                getNearbyTimeAll: [],
                getNearbyTimeMax: 0,
                gAffectCalcTime: 0,
                gAffectCalcTimeAll: [],
                gAffectCalcTimeMax: 0,
                positionUpdateTime: 0,
                positionUpdateTimeAll: [],
                positionUpdateTimeMax: 0
            };
            let totalTimeAverageUpdateMs = 1000;
            let gridResetTimeAverageUpdateMs = 1000;
            let getNearbyTimeAverageUpdateMs = 1000;
            let gAffectCalcTimeAverageUpdateMs = 1000;
            let positionUpdateTimeAverageUpdateMs = 1000;
            let totalTimeAverageUpdateLastTime = 0;
            let gridResetTimeAverageUpdateLastTime = 0;
            let getNearbyTimeAverageUpdateLastTime = 0;
            let gAffectCalcTimeAverageUpdateLastTime = 0;
            let positionUpdateTimeAverageUpdateLastTime = 0;
            let gridData = {
                cellSize: 0,
                width: 0,
                height: 0,
                selectedCell: null,
                nearbyCells: []
            };

            function update() {
                draw(particles, gridData);
                if (performanceData.totalTime > performanceData.totalTimeMax) {
                    performanceData.totalTimeMax = performanceData.totalTime;
                }
                if (performanceData.gridResetTime > performanceData.gridResetTimeMax){
                    performanceData.gridResetTimeMax = performanceData.gridResetTime;
                }
                if (performanceData.getNearbyTime > performanceData.getNearbyTimeMax){
                    performanceData.getNearbyTimeMax = performanceData.getNearbyTime;
                }
                if (performanceData.gAffectCalcTime > performanceData.gAffectCalcTimeMax){
                    performanceData.gAffectCalcTimeMax = performanceData.gAffectCalcTime;
                }
                if (performanceData.positionUpdateTime > performanceData.positionUpdateTimeMax){
                    performanceData.positionUpdateTimeMax = performanceData.positionUpdateTime;
                }
                performanceData.totalTimeAll.push(performanceData.totalTime);
                performanceData.gridResetTimeAll.push(performanceData.gridResetTime);
                performanceData.getNearbyTimeAll.push(performanceData.getNearbyTime);
                performanceData.gAffectCalcTimeAll.push(performanceData.gAffectCalcTime);
                performanceData.positionUpdateTimeAll.push(performanceData.positionUpdateTime);
                // æ›´æ–°æ€§èƒ½æ•¸æ“šé¡¯ç¤º
                document.getElementById('total-time').textContent = performanceData.totalTime.toFixed(2);
                if (performance.now() - totalTimeAverageUpdateLastTime >= totalTimeAverageUpdateMs) {
                    document.getElementById('total-time-average').textContent = (performanceData.totalTimeAll.reduce((a, b) => a + b, 0) / performanceData.totalTimeAll.length).toFixed(2);
                    performanceData.totalTimeAll = [];  
                    totalTimeAverageUpdateLastTime = performance.now();
                }
                document.getElementById('total-time-max').textContent = performanceData.totalTimeMax.toFixed(2);
                
                document.getElementById('grid-reset-time').textContent = performanceData.gridResetTime.toFixed(2);  
                if (performance.now() - gridResetTimeAverageUpdateLastTime >= gridResetTimeAverageUpdateMs) {
                    document.getElementById('grid-reset-time-average').textContent = (performanceData.gridResetTimeAll.reduce((a, b) => a + b, 0) / performanceData.gridResetTimeAll.length).toFixed(2);
                    performanceData.gridResetTimeAll = [];
                    gridResetTimeAverageUpdateLastTime = performance.now();
                }
                document.getElementById('grid-reset-time-max').textContent = performanceData.gridResetTimeMax.toFixed(2);

                document.getElementById('get-nearby-time').textContent = performanceData.getNearbyTime.toFixed(2);
                if (performance.now() - getNearbyTimeAverageUpdateLastTime >= getNearbyTimeAverageUpdateMs) {
                    document.getElementById('get-nearby-time-average').textContent = (performanceData.getNearbyTimeAll.reduce((a, b) => a + b, 0) / performanceData.getNearbyTimeAll.length).toFixed(2);
                    performanceData.getNearbyTimeAll = [];
                    getNearbyTimeAverageUpdateLastTime = performance.now();
                }
                document.getElementById('get-nearby-time-max').textContent = performanceData.getNearbyTimeMax.toFixed(2);
                
                document.getElementById('g-Affect-Calc-time').textContent = performanceData.gAffectCalcTime.toFixed(2);
                if (performance.now() - gAffectCalcTimeAverageUpdateLastTime >= gAffectCalcTimeAverageUpdateMs) {
                    document.getElementById('g-Affect-Calc-time-average').textContent = (performanceData.gAffectCalcTimeAll.reduce((a, b) => a + b, 0) / performanceData.gAffectCalcTimeAll.length).toFixed(2);
                    performanceData.gAffectCalcTimeAll = [];
                    gAffectCalcTimeAverageUpdateLastTime = performance.now();
                }
                document.getElementById('g-Affect-Calc-time-max').textContent = performanceData.gAffectCalcTimeMax.toFixed(2);
                
                document.getElementById('position-update-time').textContent = performanceData.positionUpdateTime.toFixed(2);
                if (performance.now() - positionUpdateTimeAverageUpdateLastTime >= positionUpdateTimeAverageUpdateMs) {
                    document.getElementById('position-update-time-average').textContent = (performanceData.positionUpdateTimeAll.reduce((a, b) => a + b, 0) / performanceData.positionUpdateTimeAll.length).toFixed(2);
                    performanceData.positionUpdateTimeAll = [];
                    positionUpdateTimeAverageUpdateLastTime = performance.now();
                }
                document.getElementById('position-update-time-max').textContent = performanceData.positionUpdateTimeMax.toFixed(2);

                // æ›´æ–°é¸ä¸­ç²’å­çš„å±¬æ€§é¡¯ç¤º
                if (enableParticleAffcetRadiusShow){
                    const propertyElement = document.getElementById('selectedParticleProperty');
                    if (selectedParticleId !== null && particles.length > 0) {
                        const selectedParticle = particles.find(p => p.id === selectedParticleId);
                        if (selectedParticle) {
                            const properties = [
                                `ID: ${selectedParticle.id}`,
                                `é¡å‹: ${selectedParticle.type}`,
                                `ä½ç½®: (${selectedParticle.x.toFixed(2)}, ${selectedParticle.y.toFixed(2)})`,
                                `é€Ÿåº¦: (${selectedParticle.vx.toFixed(2)}, ${selectedParticle.vy.toFixed(2)})`,
                                `é¡è‰²: ${selectedParticle.color}`,
                                `æ˜¯å¦åœ¨é‚Šç•Œå¤–: ${selectedParticle.isOutside ? 'æ˜¯' : 'å¦'}`
                            ];
                            propertyElement.innerHTML = properties.join('<br>');
                        } else {
                            propertyElement.textContent = 'æ‰¾ä¸åˆ°é¸ä¸­çš„ç²’å­';
                        }
                    } else {
                        propertyElement.textContent = 'æœªé¸ä¸­ç²’å­';
                    }
                }

                // è¨ˆç®—ä¸¦é¡¯ç¤º FPS
                frameCount++;
                const currentTime = performance.now();
                if (currentTime - lastTime >= 1000) {
                    fps = Math.round((frameCount * 1000) / (currentTime - lastTime));
                    document.getElementById('fps').textContent = fps;
                    frameCount = 0;
                    lastTime = currentTime;
                }

                requestAnimationFrame(() => {
                    worker.postMessage({ type: 'canUpdate' });
                    update();
                });
            }

            // æ¥æ”¶ä¾†è‡ª Worker çš„æ¶ˆæ¯
            worker.onmessage = function (e) {
                if (e.data.type === 'update') {
                    particles = e.data.particles;
                    gridData = e.data.gridData;
                    performanceData.totalTime = e.data.performanceData.totalTime;
                    performanceData.gridResetTime = e.data.performanceData.gridResetTime
                    performanceData.getNearbyTime = e.data.performanceData.getNearbyTime
                    performanceData.gAffectCalcTime = e.data.performanceData.gAffectCalcTime;
                    performanceData.positionUpdateTime = e.data.performanceData.positionUpdateTime;
                    nearbyParticlesOne = e.data.nearbyParticlesOne;
                    nearbyParticlesTwo = e.data.nearbyParticlesTwo;
                    nearbyParticlesThree = e.data.nearbyParticlesThree;
                    // æ›´æ–°æ‰€é¸å–®å…ƒæ ¼çš„é¡¯ç¤º
                    if (gridData.selectedCell) {
                        document.getElementById('selected-cell').textContent = `x: ${gridData.selectedCell.x}, y: ${gridData.selectedCell.y}`;
                    } else {
                        document.getElementById('selected-cell').textContent = 'ç„¡';
                    }

                    // æ›´æ–°ç¶²æ ¼å¯¬åº¦å’Œé«˜åº¦çš„é¡¯ç¤º
                    document.getElementById('grid-width').textContent = gridData.width;
                    document.getElementById('grid-height').textContent = gridData.height;
                } else if (e.data.type === 'nearbyParticles') {
                    nearbyParticlesOne = e.data.nearbyParticlesOne;
                    nearbyParticlesTwo = e.data.nearbyParticlesTwo;
                    nearbyParticlesThree = e.data.nearbyParticlesThree;
                    document.getElementById('nearbyParticlesOneNumber').textContent = nearbyParticlesOne.length;
                    document.getElementById('nearbyParticlesTwoNumber').textContent = nearbyParticlesTwo.length;
                    document.getElementById('nearbyParticlesThreeNumber').textContent = nearbyParticlesThree.length;
                }
            };

            // æ›´æ–°è¦å‰‡
            function updateRules() {
                const rules = {};
                document.querySelectorAll('input[type="range"].randomizable').forEach(slider => {
                    rules[slider.id] = parseFloat(slider.value);
                });
                worker.postMessage({ type: 'updateRules', rules });
            }

            // ç‚ºæ‰€æ»‘å¡Šå’Œæ•¸å­—è¼¸å…¥æ¡†æ·»åŠ äº‹ä»¶ç›£è½å™¨
            document.querySelectorAll('input[type="range"]').forEach(slider => {
                const numberInput = document.getElementById(slider.id + '-number');
                slider.addEventListener('input', () => {
                    numberInput.value = slider.value;
                    if (slider.className.includes('rules')) {
                        updateRules();
                    }
                });
                numberInput.addEventListener('input', () => {
                    slider.value = numberInput.value;
                    if (slider.className.includes('rules')) {
                        updateRules();
                    }
                });
            });



            // éš¨æ©ŸåŒ–å€¼
            function randomizeValues() {
                document.querySelectorAll('input[type="range"].randomizable').forEach(slider => {
                    const numberInput = document.getElementById(slider.id + '-number');
                    if (slider.id.endsWith('-distance')) {
                        const value = Math.floor(Math.random() * (300 - 10 + 1)) + 10;
                        slider.value = value;
                        numberInput.value = value;
                    } else {
                        const value = (Math.random() * 2 - 1).toFixed(1);
                        slider.value = value;
                        numberInput.value = value;
                    }
                    slider.dispatchEvent(new Event('input'));
                });
                updateRules();
            }

            // éš¨æ©ŸåŒ–ä¸¦é‡æ–°é–‹å§‹
            function randomizeAndRestart() {
                randomizeValues();
                initGame();
            }

            // æ§åˆ¶æ¿åˆ‡æ›
            const toggleButton = document.getElementById('toggle-controls');
            const controlPanel = document.getElementById('controls');

            toggleButton.addEventListener('click', () => {
                controlPanel.classList.toggle('visible');
                if (controlPanel.classList.contains('visible')) {
                    toggleButton.style.right = '310px';
                    toggleButton.textContent = 'âœ•';
                } else {
                    toggleButton.style.right = '10px';
                    toggleButton.textContent = 'â˜°';
                }
                updateCanvasSize();
            });

            // è‡ªå‹•éš±è—åˆ‡æ›æŒ‰éˆ•
            let hideTimeout;
            document.addEventListener('mousemove', () => {
                toggleButton.style.opacity = '0.5';
                clearTimeout(hideTimeout);
                hideTimeout = setTimeout(() => {
                    toggleButton.style.opacity = '0';
                }, 3000);
            });

            // åŒ¯å‡ºè¦å‰‡
            function exportRules() {
                const rules = {};
                // æ·»åŠ è¦å‰‡
                document.querySelectorAll('input[type="range"].randomizable').forEach(slider => {
                    rules[slider.id] = parseFloat(slider.value);
                });
                // æ·»åŠ ç²’å­æ•¸é‡
                ['one-particles', 'two-particles', 'three-particles'].forEach(id => {
                    rules[id] = parseInt(document.getElementById(id).value);
                });
                // æ·»åŠ ç©¿é€æ¨¡å¼ç‹€æ…‹
                rules['isThrough'] = document.getElementById('isThrough').checked;
                // æ·»åŠ é¡è‰²
                rules['one-color'] = document.getElementById('one-color').value;
                rules['two-color'] = document.getElementById('two-color').value;
                rules['three-color'] = document.getElementById('three-color').value;
                const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(rules));
                const downloadAnchorNode = document.createElement('a');
                downloadAnchorNode.setAttribute("href", dataStr);
                downloadAnchorNode.setAttribute("download", "particle_rules.json");
                document.body.appendChild(downloadAnchorNode);
                downloadAnchorNode.click();
                downloadAnchorNode.remove();
            }

            // å°å…¥è¦å‰‡
            function importRules(shouldRestart) {
                const fileInput = document.getElementById('import-file');
                fileInput.value = '';
                fileInput.dataset.shouldRestart = shouldRestart;
                fileInput.click();
            }

            function handleFileSelect(event) {
                const file = event.target.files[0];
                const shouldRestart = event.target.dataset.shouldRestart === 'true';
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function (e) {
                        const rules = JSON.parse(e.target.result);
                        Object.keys(rules).forEach(id => {
                            if (id === 'isThrough') {
                                // è¨­ç½®ç©¿é€æ¨¡å¼ç‹€æ…‹
                                const throughCheckbox = document.getElementById('isThrough');
                                throughCheckbox.checked = rules[id];
                                throughCheckbox.dispatchEvent(new Event('change'));
                            } else if (id === 'one-color' || id === 'red-color') {
                                document.getElementById('one-color').value = rules[id];
                            } else if (id === 'two-color' || id === 'blue-color') {
                                document.getElementById('two-color').value = rules[id];
                            } else if (id === 'three-color' || id === 'green-color') {
                                document.getElementById('three-color').value = rules[id];
                            } else {
                                const slider = document.getElementById(id);
                                const numberInput = document.getElementById(id + '-number');
                                if (slider && numberInput) {
                                    slider.value = rules[id];
                                    numberInput.value = rules[id];
                                    slider.dispatchEvent(new Event('input'));
                                }
                            }
                        });
                        updateRules();
                        if (shouldRestart) {
                            setTimeout(initGame, 100);
                        }
                    };
                    reader.readAsText(file);
                }
            }

            // æ›´æ–°é¡è‰²
            function updateColors() {
                const oneColor = document.getElementById('one-color').value;
                const twoColor = document.getElementById('two-color').value;
                const threeColor = document.getElementById('three-color').value;
                const One = document.querySelectorAll('.one');
                const Two = document.querySelectorAll('.two');
                const Three = document.querySelectorAll('.three');
                // æ›´æ–°æ–‡å­—å¡«å……é¡è‰²
                One.forEach(label => label.style.webkitTextFillColor = oneColor);
                Two.forEach(label => label.style.webkitTextFillColor = twoColor);
                Three.forEach(label => label.style.webkitTextFillColor = threeColor);
                
                worker.postMessage({
                    type: 'updateColors',
                    colors: {
                        one: oneColor,
                        two: twoColor,
                        three: threeColor
                    }
                });
            }

            // ç‚ºé¡è‰²é¸æ“‡å™¨æ·»åŠ äº‹ä»¶ç›£è½å™¨
            document.getElementById('one-color').addEventListener('input', updateColors);
            document.getElementById('two-color').addEventListener('input', updateColors);
            document.getElementById('three-color').addEventListener('input', updateColors);

            document.getElementById('export-rules').addEventListener('click', exportRules);
            document.getElementById('import-rules').addEventListener('click', () => importRules(false));
            document.getElementById('import-rules-and-restart').addEventListener('click', () => importRules(true));
            document.getElementById('import-file').addEventListener('change', handleFileSelect);

            let mouseX = 0;
            let mouseY = 0;
            let isMouseDown = false;
            let isUpdateMouse = false;
            let isUpdateMouseDownUp = false;

            // ç©¿é€æ¨¡å¼åˆ‡æ›
            const throughCheckbox = document.getElementById("isThrough");
            throughCheckbox.addEventListener('change', () => {
                worker.postMessage({ type: 'setThrough', isThrough: throughCheckbox.checked });
            });
            
            // æ·»åŠ æŒ‰éˆ•äº‹ä»¶ç›£è½å™¨
            document.getElementById('randomize-button').addEventListener('click', randomizeValues);
            document.getElementById('restart-button').addEventListener('click', initGame);
            document.getElementById('randomize-and-restart-button').addEventListener('click', randomizeAndRestart);
            document.addEventListener("keydown", function(event) {
                if (event.key === "r") {
                    randomizeValues();
                }
                if (event.key === "s") {
                    initGame();
                }
                if (event.key === "f") {
                    randomizeAndRestart();
                }
                if (event.key === "x") {
                    isUpdateMouseDownUp = false;
                }
                if (event.key === "m") {
                    isUpdateMouse = false;
                }
                if (event.key === "t") {
                    throughCheckbox.checked = !throughCheckbox.checked;
                    throughCheckbox.dispatchEvent(new Event('change'));
                }
            });

            // æ·»åŠ æ»‘é¼ äº‹ä»¶ç›£è½å™¨
            canvas2d.addEventListener('mousedown', (e) => {
                if (!enableParticleAffcetRadiusShow){
                    isUpdateMouseDownUp = true;
                    isUpdateMouse = true;
                    isMouseDown = true;
                    updateMousePosition(e);
                }
            });

            canvas2d.addEventListener('mouseup', () => {
                if (isUpdateMouseDownUp) {
                    isMouseDown = false;
                    worker.postMessage({ type: 'setMouseInactive' });
                }
            });

            canvas2d.addEventListener('mousemove', (e) => {
                if (isUpdateMouse) {
                    updateMousePosition(e);
                }
            });

            function updateMousePosition(e) {
                const rect = canvas2d.getBoundingClientRect();
                mouseX = e.clientX - rect.left;
                mouseY = e.clientY - rect.top;
                if (isMouseDown) {
                    worker.postMessage({ type: 'updateMousePosition', x: mouseX, y: mouseY });
                }
            }

            // ç‚ºæ»‘é¼ åŠ›é‡æ»‘å¡Šæ·»åŠ äº‹ä»¶ç›£è½å™¨
            const mouseForceSlider = document.getElementById('mouse-force');
            const mouseForceNumber = document.getElementById('mouse-force-number');
            mouseForceSlider.addEventListener('input', () => {
                worker.postMessage({ type: 'updateMouseForce', force: parseFloat(mouseForceSlider.value) });
            });
            mouseForceNumber.addEventListener('input', () => {
                worker.postMessage({ type: 'updateMouseForce', force: parseFloat(mouseForceNumber.value) });
            });

            // ç‚ºç¶²æ ¼å¤§å°æ»‘å¡Šæ·»åŠ äº‹ä»¶ç›£è½å™¨
            const cellSizeSlider = document.getElementById('cell-size');
            const cellSizeNumber = document.getElementById('cell-size-number');
            cellSizeSlider.addEventListener('input', () => {
                worker.postMessage({ type: 'updateCellSize', size: parseInt(cellSizeSlider.value) });
            }); 
            cellSizeNumber.addEventListener('input', () => {
                worker.postMessage({ type: 'updateCellSize', size: parseInt(cellSizeNumber.value) });
            });

            // ç‚ºé¸ä¸­ç¶²æ ¼è·é›¢æ»‘å¡Šæ·»åŠ äº‹ä»¶ç›£è½å™¨
            const setectGridDistanceSlider = document.getElementById('setectGridDistance');
            const setectGridDistanceNumber = document.getElementById('setectGridDistance-number');
            setectGridDistanceSlider.addEventListener('input', () => {
                worker.postMessage({ type: 'updateSetectGridDistance', distance: parseInt(setectGridDistanceSlider.value) });
            });
            setectGridDistanceNumber.addEventListener('input', () => {
                worker.postMessage({ type: 'updateSetectGridDistance', distance: parseInt(setectGridDistanceNumber.value) });
            })

            // ç‚ºæ›´æ–°é–“éš”æ»‘å¡Šæ·»åŠ äº‹ä»¶ç›£è½å™¨
            const updateIntervalSlider = document.getElementById('updateInterval');
            const updateIntervalNumber = document.getElementById('updateInterval-number');
            updateIntervalSlider.addEventListener('input', () => {
                worker.postMessage({ type: 'updateUpdateInterval', interval: parseInt(updateIntervalSlider.value) });
            });
            updateIntervalNumber.addEventListener('input', () => {
                worker.postMessage({ type: 'updateUpdateInterval', interval: parseInt(updateIntervalNumber.value) });
            }); 
            const updateIntervalUnit = document.getElementById('updateInterval-unit');
            updateIntervalUnit.addEventListener('change', () => {
                worker.postMessage({ type: 'updateUpdateInterval', interval: parseInt(updateIntervalUnit.value) });
                updateIntervalSlider.value = updateIntervalUnit.value;
                updateIntervalNumber.value = updateIntervalUnit.value;
            });

            // åˆå§‹åŒ–éŠæˆ²ä¸¦é–‹å§‹æ›´æ–°å¾ªç’°
            randomizeAndRestart();
            update()

            // æ·»åŠ ç¶²æ ¼é¡¯ç¤ºåˆ‡æ›
            const showGridCheckbox = document.getElementById('showGrid');
            showGridCheckbox.addEventListener('change', () => {
                showGrid = showGridCheckbox.checked;
                worker.postMessage({ type: 'toggleGrid', show: showGrid });
            });

            const enableParticleAffcetRadiusShowCheckbox = document.getElementById('enableParticleAffcetRadiusShow');
            enableParticleAffcetRadiusShowCheckbox.addEventListener('change', () => {
                enableParticleAffcetRadiusShow = enableParticleAffcetRadiusShowCheckbox.checked;
                worker.postMessage({ type: 'toggleParticleAffcetRadiusShow', enable: enableParticleAffcetRadiusShow });
            });

            const isOneRadiusShowCheckbox = document.getElementById('isOneRadiusShow');
            isOneRadiusShowCheckbox.addEventListener('change', () => {
                isOneRadiusShow = isOneRadiusShowCheckbox.checked;
            });
            const isTwoRadiusShowCheckbox = document.getElementById('isTwoRadiusShow');
            isTwoRadiusShowCheckbox.addEventListener('change', () => {
                isTwoRadiusShow = isTwoRadiusShowCheckbox.checked;
            });
            const isThreeRadiusShowCheckbox = document.getElementById('isThreeRadiusShow');
            isThreeRadiusShowCheckbox.addEventListener('change', () => {
                isThreeRadiusShow = isThreeRadiusShowCheckbox.checked;
            });
            // ä¿®æ”¹å–®å…ƒæ ¼é¸æ“‡åŠŸèƒ½
            canvas2d.addEventListener('click', (e) => {
                if (showGrid) {
                    const rect = canvas2d.getBoundingClientRect();
                    const x = e.clientX - rect.left;
                    const y = e.clientY - rect.top;
                    const cellX = Math.floor(x / gridCellSize);
                    const cellY = Math.floor(y / gridCellSize);
                    worker.postMessage({ type: 'selectCell', cell: { x: cellX, y: cellY } });
                    
                    // ç›´æ¥æ›´æ–°é¡¯ç¤ºï¼Œä»¥æä¾›å³æ™‚åé¥‹
                    document.getElementById('selected-cell').textContent = `x: ${cellX}, y: ${cellY}`;
                }
                
                if (enableParticleAffcetRadiusShow) {
                    const rect = canvas2d.getBoundingClientRect();
                    const x = e.clientX - rect.left;
                    const y = e.clientY - rect.top;
                    
                    // æ‰¾åˆ°æœ€è¿‘çš„ç²’å­
                    selectedParticle = particles.reduce((closest, particle) => {
                        const dx = particle.x - x;
                        const dy = particle.y - y;
                        const distance = Math.sqrt(dx * dx + dy * dy);
                        return (distance < closest.distance)&&(distance < 10) ? { particle, distance } : closest;
                    }, { particle: null, distance: Infinity }).particle;
                    if (selectedParticle) {
                        selectedParticleId = selectedParticle.id;
                        selectedParticleType = selectedParticle.type;
                        radiusOne = document.getElementById(selectedParticleType+'-one-distance');
                        radiusTwo = document.getElementById(selectedParticleType+'-two-distance');
                        radiusThree = document.getElementById(selectedParticleType+'-three-distance');
                        document.getElementById('selectedParticleId').textContent = selectedParticleId;
                        // è«‹æ±‚ worker è¨ˆç®—é™„è¿‘çš„ç²’å­
                        worker.postMessage({ 
                            type: 'updateSelectedParticle', 
                            particleId: selectedParticleId,
                        });
                    } else {
                        document.getElementById('selectedParticleId').textContent = 'ç„¡';
                        selectedParticleId = null;
                        selectedParticleType = null;
                        worker.postMessage({ 
                            type: 'updateSelectedParticle', 
                            particleId: null,
                        });
                        nearbyParticles = [];
                    }
                }
            });
        });
    </script>
</body>

</html>
